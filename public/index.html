<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BTC/USD Dashboard</title>
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/js/all.min.js"></script>
</head>
<body>
<button id="darkToggle" class="dark-toggle">ðŸŒ™ Dark Mode</button>

<div class="card">
  <h1><i class="fas fa-coins"></i> BTC/USD Live</h1>
  <div class="timeframe">
    <button data-interval="1m" class="active">1m</button>
    <button data-interval="15m">15m</button>
    <button data-interval="1H">1H</button>
    <button data-interval="4H">4H</button>
    <button data-interval="1D">1D</button>
    <button data-interval="1W">1W</button>
  </div>
  <div id="price" class="price">Loadingâ€¦</div>
  <div id="time" class="time">Waiting for dataâ€¦</div>
  <canvas id="chart"></canvas>
</div>

<script>
const priceEl = document.getElementById('price');
const timeEl = document.getElementById('time');
const ctx = document.getElementById('chart').getContext('2d');
const darkToggle = document.getElementById('darkToggle');

let lastPrice = null;
let currentMinute = null;
let lastMinutePrice = null;

const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'BTC/USD',
            data: [],
            borderColor: '#4a90e2',
            fill: false,
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        animation: {
            duration: 500,
            easing: 'easeOutQuart'
        },
        scales: {
            x: {
                type: 'time',
                time: { unit: 'minute', tooltipFormat: 'HH:mm' },
                ticks: { color: '#7f8c8d' }
            },
            y: {
                ticks: { color: '#7f8c8d' }
            }
        },
        plugins: {
            legend: { labels: { color: '#34495e' } },
            zoom: {
                zoom: {
                    wheel: { enabled: true },
                    pinch: { enabled: true },
                    mode: 'x'
                },
                pan: {
                    enabled: true,
                    mode: 'x'
                }
            }
        }
    }
});

const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}`);

ws.onopen = () => console.log('âœ… Connected ke backend WebSocket');

ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    const price = parseFloat(data.price);
    const time = new Date(parseInt(data.time));
    const timeStr = time.toLocaleTimeString();

    if (lastPrice !== null) {
        priceEl.classList.remove('up', 'down');
        if (price > lastPrice) priceEl.classList.add('up');
        else if (price < lastPrice) priceEl.classList.add('down');
    }

    lastPrice = price;
    priceEl.textContent = `$ ${price.toLocaleString()}`;
    timeEl.textContent = `Last update: ${timeStr}`;

    setTimeout(() => priceEl.classList.remove('up', 'down'), 500);

    const minute = `${time.getHours()}:${time.getMinutes()}`;
    if (currentMinute === null) {
        currentMinute = minute;
        lastMinutePrice = price;
    } else if (minute !== currentMinute) {
        chart.data.labels.push(time);
        chart.data.datasets[0].data.push(lastMinutePrice);
        chart.update();

        currentMinute = minute;
        lastMinutePrice = price;
    } else {
        lastMinutePrice = price;
    }
};

document.querySelectorAll('.timeframe button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.timeframe button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    changeTimeframe(btn.dataset.interval);
  });
});

async function changeTimeframe(interval) {
  chart.data.labels = [];
  chart.data.datasets[0].data = [];
  chart.update();

  const map = {
    '1m': '1m', '15m': '15m', '1H': '1h', '4H': '4h', '1D': '1d', '1W': '1w'
  };

  const res = await fetch(`/historical?interval=${map[interval]}`);
  const data = await res.json();

  data.forEach(d => {
    chart.data.labels.push(new Date(d.time));
    chart.data.datasets[0].data.push(d.price);
  });

  chart.update();

  if (data.length) {
    const last = new Date(data[data.length - 1].time);
    currentMinute = `${last.getHours()}:${last.getMinutes()}`;
    lastMinutePrice = chart.data.datasets[0].data.at(-1);
  }
}

darkToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    updateChartColors();
    darkToggle.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
});

function updateChartColors() {
    const isDark = document.body.classList.contains('dark');
    chart.options.scales.x.ticks.color = isDark ? '#ccc' : '#7f8c8d';
    chart.options.scales.y.ticks.color = isDark ? '#ccc' : '#7f8c8d';
    chart.options.plugins.legend.labels.color = isDark ? '#fff' : '#34495e';
    chart.update();
}

window.onload = () => {
  document.querySelector('.timeframe button[data-interval="1m"]').classList.add('active');
  changeTimeframe('1m');
};
</script>
</body>
</html>
